;window.Modernizr=function(a,b,c){function v(a){i.cssText=a}function w(a,b){return v(l.join(a+";")+(b||""))}function x(a,b){return typeof a===b}function y(a,b){return!!~(""+a).indexOf(b)}function z(a,b,d){for(var e in a){var f=b[a[e]];if(f!==c)return d===!1?a[e]:x(f,"function")?f.bind(d||b):f}return!1}var d="2.6.2",e={},f=b.documentElement,g="modernizr",h=b.createElement(g),i=h.style,j,k={}.toString,l=" -webkit- -moz- -o- -ms- ".split(" "),m={},n={},o={},p=[],q=p.slice,r,s=function(a,c,d,e){var h,i,j,k,l=b.createElement("div"),m=b.body,n=m||b.createElement("body");if(parseInt(d,10))while(d--)j=b.createElement("div"),j.id=e?e[d]:g+(d+1),l.appendChild(j);return h=["&#173;",'<style id="s',g,'">',a,"</style>"].join(""),l.id=g,(m?l:n).innerHTML+=h,n.appendChild(l),m||(n.style.background="",n.style.overflow="hidden",k=f.style.overflow,f.style.overflow="hidden",f.appendChild(n)),i=c(l,a),m?l.parentNode.removeChild(l):(n.parentNode.removeChild(n),f.style.overflow=k),!!i},t={}.hasOwnProperty,u;!x(t,"undefined")&&!x(t.call,"undefined")?u=function(a,b){return t.call(a,b)}:u=function(a,b){return b in a&&x(a.constructor.prototype[b],"undefined")},Function.prototype.bind||(Function.prototype.bind=function(b){var c=this;if(typeof c!="function")throw new TypeError;var d=q.call(arguments,1),e=function(){if(this instanceof e){var a=function(){};a.prototype=c.prototype;var f=new a,g=c.apply(f,d.concat(q.call(arguments)));return Object(g)===g?g:f}return c.apply(b,d.concat(q.call(arguments)))};return e}),m.touch=function(){var c;return"ontouchstart"in a||a.DocumentTouch&&b instanceof DocumentTouch?c=!0:s(["@media (",l.join("touch-enabled),("),g,")","{#modernizr{top:9px;position:absolute}}"].join(""),function(a){c=a.offsetTop===9}),c};for(var A in m)u(m,A)&&(r=A.toLowerCase(),e[r]=m[A](),p.push((e[r]?"":"no-")+r));return e.addTest=function(a,b){if(typeof a=="object")for(var d in a)u(a,d)&&e.addTest(d,a[d]);else{a=a.toLowerCase();if(e[a]!==c)return e;b=typeof b=="function"?b():b,typeof enableClasses!="undefined"&&enableClasses&&(f.className+=" "+(b?"":"no-")+a),e[a]=b}return e},v(""),h=j=null,e._version=d,e._prefixes=l,e.testStyles=s,e}(this,this.document);
var random=function(from,till){return Math.floor(Math.random()*(till-from+1)+from)};var scroll_top=function(){window.scrollTo(0,1)};var mixed_color=function(color){return color%2===0?true:false};var distance=function(x1,y1,x2,y2){return Math.abs(x1-x2)+Math.abs(y1-y2)};var share_facebook=function(w,h){window.open("http://www.facebook.com/share.php?u="+encodeURIComponent(location.href),"","status=0,scrollbars=0,resizable=0,width="+w+",height="+h);return false};
var share_twitter=function(text,w,h){window.open("http://twitter.com/share?url="+encodeURIComponent(location.href)+"&text="+encodeURIComponent(text),"","location=1,status=1,scrollbars=0,resizable=0,width="+w+",height="+h);return false};
var Render=function(ctx){this.ctx=ctx;ctx.textBaseline="middle";ctx.textAlign="center";this.set_color=function(color){this.ctx.fillStyle="#"+color};this.set_color_rgb=function(color){this.ctx.fillStyle=color};this.clear=function(x,y,wh){this.ctx.clearRect(x,y,wh,wh)};this.clear_all=function(x,y,w,h){this.ctx.clearRect(x,y,w,h)};this.rect=function(x,y,w,h){this.ctx.fillRect(x,y,w,h)};this.text=function(text,x,y,size){this.ctx.font="bold "+size+"px Trebuchet MS, Helvetica, sans-serif";this.ctx.fillText(text,
x,y)};this.stroke_text=function(text,x,y,size,color){this.ctx.lineWidth=3;this.ctx.strokeStyle="#"+color;this.ctx.strokeText(text,x,y)};this.square=function(x,y,wh,color){if(color)this.set_color(color);this.rect(x,y,wh,wh)}};
var Highscore=function(){this.high_score=0;this.beaten_record=0;this.load_high_score=function(){this.high_score=parseInt(localStorage.getItem("high_score"))||0};this.set_high_score=function(score){localStorage.setItem("high_score",score);this.high_score=score};this.new_score=function(new_score){console.log(new_score+" "+this.high_score);if(new_score>this.high_score){this.beaten_record++;this.set_high_score(new_score)}};this.load_high_score()};
var Game=function(){this.touch=false;var columns=10,rows=5,default_width=480,gap=48;if(window.innerWidth>default_width)gap=64;else if(window.innerWidth<default_width)gap=32;var score=0;var high_score=new Highscore;var wrapper=document.getElementById("wrapper-canvas");var canvas=document.getElementById("canvas1"),ctx=canvas.getContext("2d");var canvas_top=document.getElementById("canvas2"),ctx_top=canvas_top.getContext("2d");var width=canvas.width=canvas_top.width=wrapper.width=columns*gap;var height=
canvas.height=canvas_top.height=wrapper.height=rows*gap;canvas.style.width=canvas_top.style.width=wrapper.style.width=width+"px";canvas.style.height=canvas_top.style.height=wrapper.style.height=height+"px";var h_gap=gap/2,q_gap=gap/4,o_gap=gap/8;var canvas_matrix=[],last_click={};var render_main=new Render(ctx),render_top=new Render(ctx_top);var colors={1:"FF4444",3:"33B5E5",5:"FFBB33",4:"AA66CC",6:"FF8200",8:"99CC00"};var shades={1:"CC0000",3:"0099CC",5:"FF8800",4:"9933CC",6:"F06500",8:"669900"};
var primary_colors=[1,3,5];this.init=function(){this.init_board()};this.reset=function(){score=0;high_score.beaten_record=0;document.getElementById("score-points").innerHTML=score;this.init_board()};this.init_board=function(){for(var x=0;x<columns;x++)for(y=0;y<rows;y++){if(typeof canvas_matrix[x]=="undefined")canvas_matrix[x]=new Array(columns);color=primary_colors[random(0,2)];canvas_matrix[x][y]=color;this.draw_block(x*gap,y*gap,color)}};this.check_horizontal=function(y){var counter=0;last_color=
0;for(var x=0;x<columns;x++){var color=canvas_matrix[x][y],is_mixed=mixed_color(color);if(is_mixed)if(color==last_color)counter++;if(counter>=3&&(color!=last_color||x==columns-1)){var start_x=color!=last_color?x-counter:x-counter+1;this.animate_score(counter,shades[canvas_matrix[start_x][y]],gap);this.blocks_fall(start_x,y,counter);counter=0}if(is_mixed)if(color!=last_color)counter=1;last_color=color}};this.check_vertical=function(x){var counter=0,last_color=0;for(var y=0;y<rows;y++){var color=canvas_matrix[x][y],
is_mixed=mixed_color(color);if(is_mixed)if(color==last_color)counter++;if(counter>=3&&(color!=last_color||y==rows-1)){var start_y=color!=last_color?y-counter:y-counter+1;this.animate_score(counter,shades[canvas_matrix[x][start_y]],gap);for(var i=0;i<counter;i++)this.blocks_fall(x,start_y+i,1);this.check_vertical(x);counter=0}if(is_mixed)if(color!=last_color)counter=1;last_color=color}};this.handle_click=function(event){if(event.target!=canvas_top){alert("not_canvas");return}if(this.touch)var click_x=
Math.floor(event.clientX/gap),click_y=Math.floor(event.clientY/gap);else var click_x=Math.floor(event.layerX/gap),click_y=Math.floor(event.layerY/gap);var color=canvas_matrix[click_x][click_y];if(mixed_color(color))return;if(typeof last_click.color=="undefined"){last_click={x:click_x,y:click_y,color:color};this.draw_clicked(click_x*gap,click_y*gap,color)}else{if(color==last_click.color||distance(click_x,click_y,last_click.x,last_click.y)>1){this.draw_block(last_click.x*gap,last_click.y*gap,last_click.color);
last_click={};return}canvas_matrix[click_x][click_y]=color+last_click.color;this.draw_block(click_x*gap,click_y*gap,canvas_matrix[click_x][click_y]);this.blocks_fall(last_click.x,last_click.y,1);if(last_click.y<click_y){this.check_horizontal(click_y);this.check_vertical(click_x)}else if(last_click.x!=click_x){this.check_vertical(click_x);this.check_vertical(last_click.x)}else this.check_vertical(click_x);last_click={}}};this.blocks_fall=function(x,y,count){for(var i=0;i<count;i++){var act_x=x+i;color=
canvas_matrix[act_x][y]=y>0?canvas_matrix[act_x][y-1]:primary_colors[random(0,2)];render_main.clear(act_x*gap,y*gap,gap);this.animate_fall(act_x*gap,y*gap-gap,color);for(var n=0;n<=y;n++){var act_y=y-n;color=canvas_matrix[act_x][act_y]=act_y>0?canvas_matrix[act_x][act_y-1]:primary_colors[random(0,2)];render_main.clear(act_x*gap,act_y*gap,gap);this.animate_fall(act_x*gap,act_y*gap-gap,color)}}for(var n=0;n<=y;n++){var act_y=y-n;this.check_horizontal(act_y)}};this.draw_block=function(x,y,color){render_main.square(x,
y,gap,shades[color]);render_main.square(x+o_gap,y+o_gap,gap-q_gap,colors[color])};this.draw_clicked=function(x,y,color){render_main.set_color_rgb("rgba(0, 0, 0, 0.2)");render_main.square(x,y,gap);render_main.square(x+o_gap,y+o_gap,gap-q_gap,colors[color])};this.animate_fall=function(x,y,color){render_main.clear(x,y,gap);y+=q_gap;this.draw_block(x,y,color);if(y%gap!=0)setTimeout(function(){game.animate_fall(x,y,color)},130-y%gap)};this.animate_score=function(new_score,text_color,size){if(size<=gap){this.show_score(new_score,
text_color,size+h_gap);setTimeout(function(){game.animate_score(new_score,text_color,size+h_gap)},1E3)}else render_top.clear_all(0,0,width,height)};this.show_score=function(new_score,text_color,size){score+=new_score;document.getElementById("score-points").innerHTML=score;high_score.new_score(score);if(high_score.beaten_record===1)alert("Awesome, new record! :)");document.getElementById("score-img").className="rotate";setTimeout(function(){document.getElementById("score-img").className=""},1E3);render_top.clear_all(0,
0,width,height);render_top.set_color(text_color);render_top.text(new_score,width/2,height/2,size);render_top.stroke_text(new_score,width/2,height/2,size,"FFFFFF")};this.show_high_score=function(){alert("Your high score is "+high_score.high_score+" points")};this.share_fb=function(){share_facebook(width,height)};this.share_tw=function(){share_twitter("Hey! I`ve got score of "+score+' :D in HTML5 mobile game "Colo"',width,height)}};

